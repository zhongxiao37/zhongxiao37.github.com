---
layout: default
title: Redis的缓存机制
date: 2020-09-16 14:38 +0800
categories: redis
---

## 过期策略

### 定时删除

在设置key的时候，设置定时器，到期即删除。不过定时器会消耗资源，当key过多的时候，会消耗过多的CPU去查询哪些key需要删除。所以这个没有使用。

### 定期删除

在上述情况下，时间紧，任务重，就随机选择一部分删除就行了。

### 惰性删除

定期删除有个问题就是有些数据老是不会被删掉，只好在下次访问的时候，如果发现过期了，就删掉。

## 内存淘汰策略

就算有了上述这些方法，如果过期时间过长，没有等到清理之前，内存还是会被撑爆的。当内存不足时，就有8中内存淘汰策略。

1. noeviction：新写入操作会报错。
2. allkeys-lru：在所有键中，移除最近最少使用的key。
3. allkeys-random：在所有键中，随机移除某个key。
4. volatile-lru：在设置了过期时间的键空间中，移除最近最少使用的key。
5. volatile-random：在设置了过期时间的键空间中，随机移除某个key。
6. volatile-ttl：在设置了过期时间的键空间中，有更早过期时间的key优先移除。
7. volatile-lfu：从配置了过期时间的键中删除使用频率最少的键
8. allkeys-lfu：从所有键中删除使用频率最少的键

## 缓存击穿 && 布隆过滤器

有时候会遇到一种情况，即redis里面没有，数据库里面也没有。如果我们能够把不存在结果的情况也缓存起来，就更好了。这个时候需要启用布隆过滤器。
用上布隆过滤器以后，可以Redis有可以继续为数据库挡枪子了。

### 布隆过滤器

一般我们判断某个key是否存在于一个集合中，我们第一反应就是hash。通过hash函数和mod，我们可以很快的判断某个key是否存在于集合中。但是hash有个问题，就是存储效率不高。也就是说，如果集合过大的时候，会占用很大的空间。空间一大，要去查询也会随着更加耗时。

布隆过滤器能够占用hash存储空间的是1/4甚至1/8的空间，达到同样的效果。缺点就是会误判一些应该被标示为存在的，一般配合一个白名单即可。


## 缓存雪崩

程序上把一些热点数据也设置了时间，在某一时刻，过多的热点数据被清除掉，那缓存的意义就没有了。需要热点数据永不过期，临时数据过期时间随机。

